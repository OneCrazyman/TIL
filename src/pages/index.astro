---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllPosts, getSubcategories, getCategoryCount, getTotalCount, type Category } from '../utils/posts';
import { format } from 'date-fns';
import { ko } from 'date-fns/locale/ko';

const allPosts = getAllPosts();
const articles = getAllPosts('articles');
const tils = getAllPosts('til');
const recentArticles = articles.slice(0, 6);
const recentTils = tils.slice(0, 6);

const articleSubcategories = getSubcategories('articles');
const tilSubcategories = getSubcategories('til');
const totalCount = getTotalCount();
const articleCount = getCategoryCount('articles');
const tilCount = getCategoryCount('til');
---

<BaseLayout title="개발 아카이브">
	<div class="space-y-12">
		<!-- 헤더 섹션 -->
		<div class="border-b border-gray-200 pb-8 pt-12">
			<div class="text-center mb-8">
				<h1 class="text-4xl font-bold text-gray-900 mb-4">개발 아카이브</h1>
				<p class="text-lg text-gray-600">기술 아티클과 TIL을 기록하는 공간</p>
			</div>
			
			<!-- 카테고리 태그 섹션 -->
			<div class="mb-6">
				<div class="flex items-center justify-between mb-4">
					<h2 class="text-xl font-bold text-gray-900">카테고리 ({articleSubcategories.length + tilSubcategories.length})</h2>
				</div>
				<div class="flex flex-wrap gap-2">
					{/* 기술 아티클 서브카테고리 */}
					{articleSubcategories.map((sub) => {
						const subPosts = articles.filter(p => p.subcategory === sub);
						return (
							<a 
								href={`/articles/${sub}`}
								class="inline-flex items-center px-4 py-2 bg-white border border-purple-300 rounded-2xl text-gray-900 hover:bg-purple-50 hover:border-purple-400 transition-colors"
							>
								<span>{sub}</span>
								<span class="ml-2 text-gray-500">({subPosts.length})</span>
							</a>
						);
					})}
					
					{/* TIL 서브카테고리 */}
					{tilSubcategories.map((sub) => {
						const subPosts = tils.filter(p => p.subcategory === sub);
						return (
							<a 
								href={`/til/${sub}`}
								class="inline-flex items-center px-4 py-2 bg-white border border-purple-300 rounded-2xl text-gray-900 hover:bg-purple-50 hover:border-purple-400 transition-colors"
							>
								<span>{sub}</span>
								<span class="ml-2 text-gray-500">({subPosts.length})</span>
							</a>
						);
					})}
				</div>
			</div>
		</div>

		<!-- 최근 기술 아티클 -->
		<section>
			<div class="flex items-center justify-between mb-6">
					<h2 class="text-2xl font-bold text-gray-900">최근 기술 아티클 ({articleCount})</h2>
					<a 
						href="/articles" 
						class="text-blue-600 hover:text-blue-800 font-medium transition"
					>
						더보기 →
					</a>
				</div>
				<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
				{recentArticles.map((post) => (
					<article class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
						<div class="flex items-center gap-2 mb-3">
							<span class="px-2 py-1 text-xs font-semibold rounded bg-blue-100 text-blue-800">
								{post.subcategory}
							</span>
						</div>
						<h3 class="text-lg font-bold mb-2 line-clamp-2">
							<a 
								href={`/${post.category}/${post.subcategory}/${post.slug}`}
								class="hover:text-blue-600 transition"
							>
								{post.title}
							</a>
						</h3>
						{post.description && (
							<p class="text-sm text-gray-600 mb-3 line-clamp-2">{post.description}</p>
						)}
						{post.tags && post.tags.length > 0 && (
							<div class="flex flex-wrap gap-1 mb-3">
								{post.tags.slice(0, 3).map((tag) => (
									<a 
										href={`/tag/${tag}`}
										class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition"
									>
										#{tag}
									</a>
								))}
							</div>
						)}
						<div class="flex items-center justify-between text-xs text-gray-500">
							<time>
								{format(new Date(post.date), 'yyyy.MM.dd', { locale: ko })}
							</time>
							<a 
								href={`/${post.category}/${post.subcategory}/${post.slug}`}
								class="text-blue-600 hover:text-blue-800"
							>
								읽기 →
							</a>
						</div>
					</article>
				))}
			</div>
		</section>

		<!-- 최근 TIL -->
		<section>
			<div class="flex items-center justify-between mb-6">
					<h2 class="text-2xl font-bold text-gray-900">최근 TIL ({tilCount})</h2>
					<a 
						href="/til" 
						class="text-green-600 hover:text-green-800 font-medium transition"
					>
						더보기 →
					</a>
				</div>
				<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
				{recentTils.map((post) => (
					<article class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
						<div class="flex items-center gap-2 mb-3">
							<span class="px-2 py-1 text-xs font-semibold rounded bg-green-100 text-green-800">
								{post.subcategory}
							</span>
						</div>
						<h3 class="text-lg font-bold mb-2 line-clamp-2">
							<a 
								href={`/${post.category}/${post.subcategory}/${post.slug}`}
								class="hover:text-green-600 transition"
							>
								{post.title}
							</a>
						</h3>
						{post.description && (
							<p class="text-sm text-gray-600 mb-3 line-clamp-2">{post.description}</p>
						)}
						{post.tags && post.tags.length > 0 && (
							<div class="flex flex-wrap gap-1 mb-3">
								{post.tags.slice(0, 3).map((tag) => (
									<a 
										href={`/tag/${tag}`}
										class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition"
									>
										#{tag}
									</a>
								))}
							</div>
						)}
						<div class="flex items-center justify-between text-xs text-gray-500">
							<time>
								{format(new Date(post.date), 'yyyy.MM.dd', { locale: ko })}
							</time>
							<a 
								href={`/${post.category}/${post.subcategory}/${post.slug}`}
								class="text-green-600 hover:text-green-800"
							>
								읽기 →
							</a>
						</div>
					</article>
				))}
			</div>
		</section>
	</div>
</BaseLayout>
